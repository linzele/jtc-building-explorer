<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JTC Building Explorer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
</head>
<body>
    <div id="app-container">
        <!-- Map -->
        <div id="map"></div>

        <!-- Header Bar -->
        <div id="header-bar">
            <div class="header-brand">
                <i class="bi bi-buildings"></i>
                <span>JTC Building Explorer</span>
            </div>
            <div class="header-stats">
                <span class="stat-badge">
                    <i class="bi bi-geo-alt-fill"></i>
                    <span id="building-count">0</span> buildings
                </span>
            </div>
        </div>

        <!-- Layer Control Panel -->
        <div id="layer-panel" class="card">
            <div class="card-header">
                <i class="bi bi-layers-fill"></i> Controls
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="layer-jtc-buildings" role="switch">
                    <label class="form-check-label" for="layer-jtc-buildings">
                        <i class="bi bi-building"></i> Show JTC Buildings
                    </label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="layer-sla-districts" role="switch">
                    <label class="form-check-label" for="layer-sla-districts">
                        <i class="bi bi-bounding-box"></i> Show Survey Districts
                    </label>
                </div>
                <div class="filter-section">
                    <label class="form-label" for="building-type-filter">
                        <i class="bi bi-funnel"></i> Filter by Type
                    </label>
                    <select id="building-type-filter" class="form-select form-select-sm" title="Filter buildings by type">
                        <option value="">All Building Types</option>
                    </select>
                </div>
                <div class="legend-section mt-3">
                    <label class="form-label small text-muted">Legend</label>
                    <div class="legend-items">
                        <div class="legend-item"><span class="legend-color legend-factory"></span>Factory Land Standard</div>
                        <div class="legend-item"><span class="legend-color legend-terrace"></span>Terrace Factory</div>
                        <div class="legend-item"><span class="legend-color legend-flatted"></span>Flatted Factory</div>
                        <div class="legend-item"><span class="legend-color legend-stackup"></span>Stack-up Factory</div>
                        <div class="legend-item"><span class="legend-color legend-business"></span>Business Park</div>
                        <div class="legend-item"><span class="legend-color" style="background: rgba(128, 0, 128, 0.3); border: 2px solid #800080;"></span>Survey District</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Assistant -->
        <div id="chat-container">
            <div class="chat-header d-flex justify-content-between align-items-center">
                <div>
                    <span class="assistant-avatar">üè≠</span> JTC Assistant
                </div>
                <button class="btn btn-sm btn-link text-white p-0" onclick="toggleChat()" title="Toggle chat">
                    <i class="bi bi-dash-lg"></i>
                </button>
            </div>
            <div class="chat-body" id="chat-messages">
                <div class="chat-bubble assistant">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>
            <div class="chat-footer">
                <div class="input-group">
                    <input type="text" id="chat-input" class="form-control" placeholder="Ask about buildings...">
                    <button class="btn btn-primary" onclick="sendMessage()" title="Send message" aria-label="Send message">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay">
            <div class="loading-content">
                <div class="spinner-border text-primary" role="status"></div>
                <div class="loading-text">Loading buildings...</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ---------------------- Map Setup ----------------------
        const map = L.map('map', { zoomControl: false }).setView([1.3521, 103.8198], 12);
        
        // Zoom control on bottom right
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // OneMap Grey basemap (cleaner look)
        L.tileLayer('https://www.onemap.gov.sg/maps/tiles/Grey/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.onemap.gov.sg">OneMap</a>',
            maxZoom: 19
        }).addTo(map);

        // Layer groups
        const jtcBuildingsLayer = L.layerGroup().addTo(map);
        const demoParcelsLayer = L.layerGroup().addTo(map);
        const slaDistrictsLayer = L.layerGroup().addTo(map);
        
        // Track highlighted postal codes
        let highlightedPostalCodes = [];

        // ---------------------- Layer Loading ----------------------
        
        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        function getBuildingColor(desc) {
            if (desc.includes('Terrace Factory')) return '#fd7e14';
            if (desc.includes('Flatted Factory')) return '#6f42c1';
            if (desc.includes('Stack-up')) return '#20c997';
            if (desc.includes('Business Park')) return '#0d6efd';
            return '#28a745'; // Default green
        }
        
        // ---------------------- SLA Survey Districts ----------------------
        
        async function loadSlaDistricts() {
            try {
                const resp = await fetch('/api/sla-districts');
                const data = await resp.json();
                
                slaDistrictsLayer.clearLayers();
                
                if (data.features) {
                    L.geoJSON(data, {
                        style: function(feature) {
                            return {
                                color: '#800080',
                                weight: 2,
                                fillColor: '#800080',
                                fillOpacity: 0.1,
                                dashArray: '5, 5'
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            const desc = feature.properties.Description || '';
                            
                            // Parse district info
                            const districtMatch = desc.match(/SURVEY_DISTRICT<\/th>\s*<td>([^<]+)/);
                            const crcMatch = desc.match(/INC_CRC<\/th>\s*<td>([^<]+)/);
                            const dateMatch = desc.match(/FMEL_UPD_D<\/th>\s*<td>([^<]+)/);
                            
                            const districtCode = districtMatch ? districtMatch[1].trim() : 'Unknown';
                            const crc = crcMatch ? crcMatch[1].trim() : 'N/A';
                            const updateDate = dateMatch ? dateMatch[1].trim() : 'N/A';
                            
                            // Format date (YYYYMMDDHHMMSS -> readable)
                            let formattedDate = updateDate;
                            if (updateDate && updateDate.length >= 8) {
                                formattedDate = `${updateDate.slice(0,4)}-${updateDate.slice(4,6)}-${updateDate.slice(6,8)}`;
                            }
                            
                            // Determine district type from code
                            let districtType = 'Unknown';
                            if (districtCode.startsWith('MK')) {
                                districtType = 'Mukim (Rural)';
                            } else if (districtCode.startsWith('TS')) {
                                districtType = 'Town Subdivision';
                            }
                            
                            const popup = `
                                <div class="building-popup">
                                    <div class="popup-header" style="background: #800080;">
                                        <i class="bi bi-bounding-box"></i> Survey District ${districtCode}
                                    </div>
                                    <div class="popup-body">
                                        <div class="popup-row"><span class="popup-label">Type:</span>${districtType}</div>
                                        <div class="popup-row"><span class="popup-label">Code:</span>${districtCode}</div>
                                        <div class="popup-row"><span class="popup-label">Updated:</span>${formattedDate}</div>
                                    </div>
                                </div>`;
                            
                            layer.bindPopup(popup);
                            
                            // Hover effect
                            layer.on('mouseover', function() {
                                this.setStyle({ weight: 3, fillOpacity: 0.25 });
                            });
                            layer.on('mouseout', function() {
                                this.setStyle({ weight: 2, fillOpacity: 0.1 });
                            });
                        }
                    }).addTo(slaDistrictsLayer);
                    
                    console.log(`Loaded ${data.count} SLA survey districts`);
                }
            } catch (e) {
                console.error('Failed to load SLA districts:', e);
            }
        }
        
        // Look up district for a coordinate
        async function lookupDistrict(lon, lat) {
            try {
                const resp = await fetch(`/api/sla-districts/lookup?lon=${lon}&lat=${lat}`);
                return await resp.json();
            } catch (e) {
                console.error('District lookup failed:', e);
                return null;
            }
        }

        // ---------------------- Demo Land Parcels ----------------------
        
        async function loadDemoParcels(postalCodesToHighlight = null) {
            // If no postal codes provided, don't show any parcels
            if (!postalCodesToHighlight || postalCodesToHighlight.length === 0) {
                demoParcelsLayer.clearLayers();
                return;
            }
            
            try {
                const resp = await fetch('/api/demo-land-parcels');
                const data = await resp.json();
                
                demoParcelsLayer.clearLayers();
                highlightedPostalCodes = postalCodesToHighlight;
                
                if (data.features) {
                    // Only show parcels that match the requested postal codes
                    const matchingFeatures = data.features.filter(feature => 
                        postalCodesToHighlight.includes(feature.properties.postal_code)
                    );
                    
                    matchingFeatures.forEach(feature => {
                        const props = feature.properties;
                        const coords = feature.geometry.coordinates;
                        
                        // Highlighted marker style - all parcels use same color
                        let markerColor = '#e74c3c';
                        let markerSize = 18;
                        let borderColor = '#ffff00';
                        let borderWidth = 4;
                        
                        // Create custom div icon
                        const icon = L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="
                                width: ${markerSize}px;
                                height: ${markerSize}px;
                                background: ${markerColor};
                                border: ${borderWidth}px solid ${borderColor};
                                border-radius: 50%;
                                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                                animation: pulse 1s infinite;
                            "></div>`,
                            iconSize: [markerSize + borderWidth*2, markerSize + borderWidth*2],
                            iconAnchor: [(markerSize + borderWidth*2)/2, (markerSize + borderWidth*2)/2]
                        });
                        
                        const marker = L.marker([coords[1], coords[0]], { icon });
                        
                        // Popup content
                        // Random building types for highlighted parcels
                        const buildingTypes = ['Business Park', 'Terrace Factory', 'Flatted Factory', 'Stack-up Factory', 'Factory Land Standard'];
                        const randomType = buildingTypes[Math.floor(Math.random() * buildingTypes.length)];
                        
                        const popup = `
                            <div class="building-popup">
                                <div class="popup-header">
                                    <i class="bi bi-geo-alt-fill"></i> ${props.name}
                                </div>
                                <div class="popup-body">
                                    <div class="popup-row"><span class="popup-label">Postal:</span>${props.postal_code}</div>
                                    <div class="popup-row"><span class="popup-label">Area:</span>${props.land_area}</div>
                                    <div class="popup-row"><span class="popup-label">Zoning:</span>${props.zoning}</div>
                                    <div class="popup-row"><span class="popup-label">Type:</span>
                                        <span style="color: #0d6efd; font-weight: bold;">
                                            ${props.building_type || randomType}
                                        </span>
                                    </div>
                                    ${props.survey_district ? `<div class="popup-row"><span class="popup-label">District:</span><span style="color: #800080; font-weight: bold;">${props.survey_district}</span></div>` : ''}
                                </div>
                            </div>`;
                        
                        marker.bindPopup(popup);
                        marker.addTo(demoParcelsLayer);
                    });
                    
                    // Update count with number of matching features
                    document.getElementById('building-count').textContent = matchingFeatures.length;
                    
                    // Fit bounds to markers
                    if (matchingFeatures.length > 0) {
                        const bounds = L.latLngBounds(
                            matchingFeatures.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0]])
                        );
                        map.fitBounds(bounds, { padding: [80, 80], maxZoom: 13 });
                    }
                }
            } catch (e) {
                console.error('Failed to load demo parcels:', e);
            }
        }

        // Load building types for filter dropdown
        async function loadBuildingTypes() {
            try {
                const resp = await fetch('/api/jtc-building-types');
                const data = await resp.json();
                
                const select = document.getElementById('building-type-filter');
                if (data.building_types) {
                    data.building_types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.toLowerCase();
                        option.textContent = type;
                        select.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('Failed to load building types:', e);
            }
        }

        // Store all building features for postal code filtering
        let allBuildingFeatures = [];

        async function loadJtcBuildings(postalCodes = null) {
            showLoading(true);
            const buildingType = document.getElementById('building-type-filter').value;
            try {
                let url = '/api/jtc-buildings';
                if (buildingType) {
                    url += `?building_type=${encodeURIComponent(buildingType)}`;
                }
                
                const resp = await fetch(url);
                const data = await resp.json();
                
                jtcBuildingsLayer.clearLayers();
                
                if (data.features) {
                    // Store all features for later filtering
                    allBuildingFeatures = data.features;
                    
                    // Filter by postal codes if provided
                    let featuresToShow = data.features;
                    if (postalCodes && postalCodes.length > 0) {
                        featuresToShow = data.features.filter(f => {
                            const desc = f.properties?.Description || '';
                            const postalMatch = desc.match(/POSTAL_CODE<\/th>\s*<td>([^<]+)/);
                            const postal = postalMatch ? postalMatch[1].trim() : '';
                            return postalCodes.includes(postal);
                        });
                    }
                    
                    L.geoJSON({ type: 'FeatureCollection', features: featuresToShow }, {
                        style: function(feature) {
                            const desc = feature.properties.Description || '';
                            const isHighlighted = postalCodes && postalCodes.length > 0;
                            return {
                                color: isHighlighted ? '#ff0000' : getBuildingColor(desc),
                                weight: isHighlighted ? 4 : 2,
                                fillOpacity: isHighlighted ? 0.7 : 0.5,
                                opacity: 0.8
                            };
                        },
                        onEachFeature: (feature, layer) => {
                            const props = feature.properties;
                            const desc = props.Description || '';
                            
                            // Extract building info from HTML
                            const info = {
                                status: desc.match(/BUILDING_STATUS<\/th>\s*<td>([^<]+)/)?.[1] || 'N/A',
                                type: desc.match(/JTC_BUILDING_TYPE<\/th>\s*<td>([^<]+)/)?.[1] || 'N/A',
                                block: desc.match(/BLOCK_NO<\/th>\s*<td>([^<]+)/)?.[1] || 'N/A',
                                postal: desc.match(/POSTAL_CODE<\/th>\s*<td>([^<]+)/)?.[1] || 'N/A'
                            };
                            
                            const popup = `
                                <div class="building-popup">
                                    <div class="popup-header"><i class="bi bi-building"></i> Block ${info.block}</div>
                                    <div class="popup-body">
                                        <div class="popup-row"><span class="popup-label">Type:</span>${info.type}</div>
                                        <div class="popup-row"><span class="popup-label">Status:</span>${info.status}</div>
                                        <div class="popup-row"><span class="popup-label">Postal:</span>${info.postal}</div>
                                    </div>
                                </div>`;
                            
                            layer.bindPopup(popup);
                            
                            // Hover effect
                            layer.on('mouseover', function() { this.setStyle({ weight: 4, fillOpacity: 0.7 }); });
                            layer.on('mouseout', function() { this.setStyle({ weight: 2, fillOpacity: 0.5 }); });
                        }
                    }).addTo(jtcBuildingsLayer);
                    
                    document.getElementById('building-count').textContent = featuresToShow.length.toLocaleString();
                    
                    // Fit map to highlighted buildings if filtering by postal codes
                    if (postalCodes && postalCodes.length > 0 && featuresToShow.length > 0) {
                        const bounds = L.geoJSON({ type: 'FeatureCollection', features: featuresToShow }).getBounds();
                        if (bounds.isValid()) {
                            map.fitBounds(bounds, { padding: [50, 50] });
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to load JTC buildings:', e);
            }
            showLoading(false);
        }

        // ---------------------- Event Handlers ----------------------
        
        document.getElementById('layer-jtc-buildings').addEventListener('change', function() {
            if (this.checked) {
                loadJtcBuildings();
            } else {
                jtcBuildingsLayer.clearLayers();
            }
            updateBuildingCount();
        });
        
        document.getElementById('layer-sla-districts').addEventListener('change', function() {
            if (this.checked) {
                loadSlaDistricts();
            } else {
                slaDistrictsLayer.clearLayers();
            }
        });

        document.getElementById('building-type-filter').addEventListener('change', function() {
            if (document.getElementById('layer-jtc-buildings').checked) {
                loadJtcBuildings();
            }
        });
        
        function updateBuildingCount() {
            let count = demoParcelsLayer.getLayers().length;
            if (document.getElementById('layer-jtc-buildings').checked) {
                count += jtcBuildingsLayer.getLayers().length;
            }
            document.getElementById('building-count').textContent = count;
        }

        // ---------------------- Chat ----------------------
        
        function toggleChat() {
            const body = document.getElementById('chat-messages');
            const footer = document.querySelector('#chat-container .chat-footer');
            const icon = document.querySelector('#chat-container .chat-header .bi');
            
            if (body.style.display === 'none') {
                body.style.display = 'block';
                footer.style.display = 'block';
                icon.className = 'bi bi-dash-lg';
            } else {
                body.style.display = 'none';
                footer.style.display = 'none';
                icon.className = 'bi bi-plus-lg';
            }
        }

        function addChatMessage(text, isUser = false) {
            const container = document.getElementById('chat-messages');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isUser ? 'user' : 'assistant'}`;
            bubble.innerHTML = text;
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;
            
            addChatMessage(msg, true);
            input.value = '';
            
            // Show typing indicator
            const typingBubble = document.createElement('div');
            typingBubble.className = 'chat-bubble assistant typing';
            typingBubble.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            document.getElementById('chat-messages').appendChild(typingBubble);
            document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
            
            try {
                // Use chat-with-tools endpoint for enhanced functionality
                const resp = await fetch('/api/chat-with-tools', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                
                // Remove typing indicator
                typingBubble.remove();
                
                const data = await resp.json();
                
                if (data.error) {
                    addChatMessage('Sorry, I encountered an error. Please try again.');
                } else {
                    // Handle any map actions returned by the API
                    if (data.action) {
                        handleChatAction(data.action);
                    }
                    addChatMessage(data.response.replace(/\n/g, '<br>'));
                }
            } catch (e) {
                typingBubble.remove();
                console.error('Chat error:', e);
                addChatMessage('Sorry, I could not process your request. Please try again.');
            }
        }
        
        // Track highlighted districts
        let highlightedDistricts = [];
        
        // Handle map actions from chat API
        function handleChatAction(action) {
            switch(action.type) {
                case 'show_buildings':
                    document.getElementById('layer-jtc-buildings').checked = true;
                    if (action.filter) {
                        document.getElementById('building-type-filter').value = action.filter;
                    } else {
                        document.getElementById('building-type-filter').value = '';
                    }
                    loadJtcBuildings();
                    break;
                case 'highlight_postal_codes':
                    // Highlight demo parcels by postal codes
                    loadDemoParcels(action.postal_codes);
                    break;
                case 'highlight_districts':
                    // Highlight specific survey districts
                    highlightDistricts(action.district_codes);
                    break;
                case 'document_generated':
                    // Document was generated and uploaded - show notification
                    showDocumentNotification(action.document_url, action.parcel_name);
                    // Also highlight the parcel on the map
                    if (action.postal_code) {
                        loadDemoParcels([action.postal_code]);
                    }
                    break;
                case 'document_generated_local':
                    // Document was saved locally
                    console.log('Document saved locally:', action.filepath);
                    break;
                case 'clear_map':
                    document.getElementById('layer-jtc-buildings').checked = false;
                    document.getElementById('layer-sla-districts').checked = false;
                    document.getElementById('building-type-filter').value = '';
                    jtcBuildingsLayer.clearLayers();
                    demoParcelsLayer.clearLayers();
                    slaDistrictsLayer.clearLayers();
                    highlightedPostalCodes = [];
                    highlightedDistricts = [];
                    document.getElementById('building-count').textContent = '0';
                    break;
                case 'show_districts':
                    document.getElementById('layer-sla-districts').checked = true;
                    loadSlaDistricts();
                    break;
            }
        }
        
        // Highlight specific districts on the map
        async function highlightDistricts(districtCodes) {
            highlightedDistricts = districtCodes;
            
            // Enable districts layer if not already
            document.getElementById('layer-sla-districts').checked = true;
            
            try {
                // Fetch districts filtered by codes
                const codesParam = districtCodes.join(',');
                const resp = await fetch(`/api/sla-districts?districts=${codesParam}`);
                const allData = await resp.json();
                
                slaDistrictsLayer.clearLayers();
                
                if (allData.features) {
                    const bounds = [];
                    
                    L.geoJSON(allData, {
                        style: function(feature) {
                            const desc = feature.properties.Description || '';
                            const districtMatch = desc.match(/SURVEY_DISTRICT<\/th>\s*<td>([^<]+)/);
                            const districtCode = districtMatch ? districtMatch[1].trim() : '';
                            const isHighlighted = districtCodes.includes(districtCode);
                            
                            return {
                                color: isHighlighted ? '#ff4444' : '#800080',
                                weight: isHighlighted ? 4 : 2,
                                fillColor: isHighlighted ? '#ff4444' : '#800080',
                                fillOpacity: isHighlighted ? 0.35 : 0.1,
                                dashArray: isHighlighted ? null : '5, 5'
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            const desc = feature.properties.Description || '';
                            
                            // Parse district info
                            const districtMatch = desc.match(/SURVEY_DISTRICT<\/th>\s*<td>([^<]+)/);
                            const crcMatch = desc.match(/INC_CRC<\/th>\s*<td>([^<]+)/);
                            const dateMatch = desc.match(/FMEL_UPD_D<\/th>\s*<td>([^<]+)/);
                            
                            const districtCode = districtMatch ? districtMatch[1].trim() : 'Unknown';
                            const isHighlighted = districtCodes.includes(districtCode);
                            const updateDate = dateMatch ? dateMatch[1].trim() : 'N/A';
                            
                            // Format date
                            let formattedDate = updateDate;
                            if (updateDate && updateDate.length >= 8) {
                                formattedDate = `${updateDate.slice(0,4)}-${updateDate.slice(4,6)}-${updateDate.slice(6,8)}`;
                            }
                            
                            // Determine district type
                            let districtType = 'Unknown';
                            if (districtCode.startsWith('MK')) {
                                districtType = 'Mukim (Rural)';
                            } else if (districtCode.startsWith('TS')) {
                                districtType = 'Town Subdivision';
                            }
                            
                            const headerColor = isHighlighted ? '#ff4444' : '#800080';
                            const popup = `
                                <div class="building-popup">
                                    <div class="popup-header" style="background: ${headerColor};">
                                        <i class="bi bi-bounding-box"></i> Survey District ${districtCode}
                                        ${isHighlighted ? '<span class="badge bg-warning text-dark ms-2">Highlighted</span>' : ''}
                                    </div>
                                    <div class="popup-body">
                                        <div class="popup-row"><span class="popup-label">Type:</span>${districtType}</div>
                                        <div class="popup-row"><span class="popup-label">Code:</span>${districtCode}</div>
                                        <div class="popup-row"><span class="popup-label">Updated:</span>${formattedDate}</div>
                                    </div>
                                </div>`;
                            
                            layer.bindPopup(popup);
                            
                            // Collect bounds for highlighted districts
                            if (isHighlighted) {
                                bounds.push(layer.getBounds());
                            }
                            
                            // Hover effect
                            layer.on('mouseover', function() {
                                this.setStyle({ weight: isHighlighted ? 5 : 3, fillOpacity: isHighlighted ? 0.45 : 0.25 });
                            });
                            layer.on('mouseout', function() {
                                this.setStyle({ weight: isHighlighted ? 4 : 2, fillOpacity: isHighlighted ? 0.35 : 0.1 });
                            });
                        }
                    }).addTo(slaDistrictsLayer);
                    
                    // Fit map to highlighted districts
                    if (bounds.length > 0) {
                        let combinedBounds = bounds[0];
                        for (let i = 1; i < bounds.length; i++) {
                            combinedBounds.extend(bounds[i]);
                        }
                        map.fitBounds(combinedBounds, { padding: [50, 50], maxZoom: 14 });
                    }
                    
                    console.log(`Highlighted ${districtCodes.length} districts: ${districtCodes.join(', ')}`);
                }
            } catch (e) {
                console.error('Failed to highlight districts:', e);
            }
        }
        
        // Show a notification when document is generated
        function showDocumentNotification(url, parcelName) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = 'document-toast';
            toast.innerHTML = `
                <div class="toast-content">
                    <i class="fas fa-file-word"></i>
                    <div class="toast-text">
                        <strong>Document Generated!</strong>
                        <p>${parcelName}</p>
                    </div>
                    <a href="${url}" target="_blank" class="toast-download">
                        <i class="fas fa-download"></i> Download
                    </a>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
            `;
            document.body.appendChild(toast);
            
            // Auto-remove after 30 seconds
            setTimeout(() => {
                if (toast.parentElement) toast.remove();
            }, 30000);
        }

        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });

        // ---------------------- Init ----------------------
        
        // Map click handler to lookup district
        map.on('click', async function(e) {
            // Only lookup if districts layer is enabled and click isn't on a marker/polygon
            if (!document.getElementById('layer-sla-districts').checked) return;
            
            const { lat, lng } = e.latlng;
            const result = await lookupDistrict(lng, lat);
            
            if (result && result.found) {
                const district = result.district;
                let districtType = 'Unknown';
                if (district.survey_district && district.survey_district.startsWith('MK')) {
                    districtType = 'Mukim (Rural)';
                } else if (district.survey_district && district.survey_district.startsWith('TS')) {
                    districtType = 'Town Subdivision';
                }
                
                L.popup()
                    .setLatLng(e.latlng)
                    .setContent(`
                        <div class="building-popup">
                            <div class="popup-header" style="background: #800080;">
                                <i class="bi bi-crosshair"></i> Location Lookup
                            </div>
                            <div class="popup-body">
                                <div class="popup-row"><span class="popup-label">District:</span><strong style="color: #800080;">${district.survey_district}</strong></div>
                                <div class="popup-row"><span class="popup-label">Type:</span>${districtType}</div>
                                <div class="popup-row"><span class="popup-label">Coords:</span>${lat.toFixed(4)}, ${lng.toFixed(4)}</div>
                            </div>
                        </div>
                    `)
                    .openOn(map);
            }
        });
        
        async function init() {
            // Load building types for filter
            await loadBuildingTypes();
            
            // Don't load demo parcels by default - they will appear when user asks about chemicals
            
            // Load welcome message
            try {
                const resp = await fetch('/api/welcome');
                const data = await resp.json();
                document.querySelector('#chat-messages .chat-bubble').innerHTML = data.message.replace(/\n/g, '<br>');
            } catch (e) {
                document.querySelector('#chat-messages .chat-bubble').textContent = 'Welcome! Ask me about JTC buildings and developments.';
            }
        }

        init();
    </script>
    <style>
        /* Pulse animation for highlighted markers */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .custom-marker {
            background: transparent;
            border: none;
        }
    </style>
</body>
</html>
